--------------------------------------------------
PROJECT STATUS SUMMARY (2026-01-31)
--------------------------------------------------

GOAL
- Build a Cloudflare-first Next.js app to learn vocabulary from film/series subtitles.
- Core flow: upload subtitle -> parse -> store vocab -> learn -> track progress.

WHAT IS IMPLEMENTED
1) Upload + Processing
   - Admin uploads subtitle at /upload (R2 storage).
   - Processing queue OR inline processing:
     - If Cloudflare Queue is configured, job is enqueued.
     - If not, processing runs inline on upload.
   - Subtitle parsing extracts sentences and terms.
   - POS tagging + lemma extraction with wink-nlp (lazy-loaded).
   - Occurrences stored in D1 (vocab_occurrences + vocab_terms + subtitle_files).

2) Vocabulary + Learning Pages (D1-backed)
   - /dashboard: shows content + progress stats (per user when logged in).
   - /film/[filmId]: shows episodes for a contentId from D1.
   - /[contentId]/[episodeId]: shows vocab list with meanings + status buttons.
   - /episode/[episodeId]: direct episode vocab view (legacy route).

3) Authentication + Roles
   - Username/password auth (no email).
   - First registered user becomes ADMIN.
   - Admin-only: /upload, /processing, /subtitles, /usage, and upload API.
   - Sessions stored in D1; cookie-based session token.

4) Progress Tracking
   - word_status table: per-user status (new/learned/weak).
   - Status buttons persist through /api/vocab/status.
   - Dashboard progress counts learned terms per user.

5) Translation (Bangla meaning)
   - Google Translate API supported (GOOGLE_TRANSLATE_API_KEY).
   - Optional TRANSLATION_API_URL (custom service).
   - Workers AI fallback if configured (CLOUDFLARE_ACCOUNT_ID, CLOUDFLARE_API_TOKEN).
   - Monthly usage tracking in D1 (translation_usage) with character limit.
   - Limit controlled by TRANSLATION_CHAR_LIMIT (default 500000).

6) Admin Usage Screen
   - /usage shows current month translation usage + limit (UTC).

DEPLOYMENT & CONFIG
- Build command for CI: npm run build:cf
- Deploy command: npx wrangler deploy
- Custom domain: learn.ataullah.dev -> worker "vocab".

REQUIRED CLOUD RESOURCES
- D1: vocab-db (binding: VOCAB_DB)
- R2: vocab-subtitles (binding: SUBTITLE_BUCKET)
- Optional Queue: vocab-subtitles-queue (binding: SUBTITLE_QUEUE)

MIGRATIONS
- 0002_vocab_schema.sql (current schema used by app)
- 0003_seed.sql (demo data; optional)
- 0004_word_status.sql (status table + pos column)
- 0005_translation_usage.sql (monthly usage tracking)
- 0006_auth.sql (users + sessions)

RUNNING LOCAL
- npm run migrate:local
- npm run dev:webpack (Turbopack still crashes)

KNOWN ISSUE (ACTIVE)
- Production error: "Cannot read properties of undefined (reading 'default')"
  Suspected cause: CJS/ESM default import issue from wink-nlp model.
  Fix applied: lazy-load NLP by dynamic import inside processing only.
  File changed: src/lib/subtitles/queue.ts
  Next step: push + deploy, then re-test /dashboard.

NEXT STEPS (IF ERROR PERSISTS)
- Use wrangler tail to get full error logs:
  wrangler tail vocab --format json
- If error persists after deploy, check module causing "default" error.

--------------------------------------------------
